---
title: 修复 Mizuki 主题在子路径部署下首页 Banner 不显示的 Bug
published: 2025-01-27
tags: [Mizuki, Astro, Debug]
category: 博客
draft: false
description: 分析并解决当 Astro 博客部署在子路径时，首页 Banner 及打字机特效无法正确加载的问题。
licenseName: "CC BY-NC-SA 4.0"
---

# 问题描述

在使用 Mizuki 主题搭建 Astro 博客时，如果将博客部署在子路径（例如 `https://example.com/Mistn/`），会遇到以下问题：

1.  **首屏加载异常**：用户首次访问首页或强制刷新时，顶部的 Banner 图片及打字机文字特效不显示，呈现为空白或默认背景。
2.  **交互恢复**：在点击文章链接跳转并返回首页后（触发 Swup 无刷新跳转），Banner 及特效能够正常显示。
3.  **移动端异常**：手机端访问时，Banner 区域被错误折叠或隐藏。

# 原因分析

经过排查 `src/layouts/MainGridLayout.astro` 文件，发现该问题的根源在于**首页判断逻辑（Route Matching）**不仅严苛且未考虑 Astro 的 `base` 配置。

源代码中通过以下逻辑判断当前页面是否为首页：

```javascript
// 源代码逻辑
const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "";
```

当博客部署在根目录时，`Astro.url.pathname` 为 `/`，逻辑成立。
但当博客配置了 `base: "/Mistn"` 时，首页的 `pathname` 实际为 `/Mistn/`。由于 `/Mistn/` 不等于 `/`，导致 `isHomePage` 被判定为 `false`。

这一判定结果直接影响了后续的 CSS 类名生成：
*   `showHomeText` 变为 `false`，导致文字容器被添加 `hidden` 类。
*   `mobileNonHomeBannerClass` 生效，导致移动端 Banner 被隐藏。

# 解决方案

修改 `src/layouts/MainGridLayout.astro` 文件，引入 `import.meta.env.BASE_URL` 以动态获取配置的基础路径，并优化路径匹配逻辑。

### 修改前（Original Code）

```javascript
// 检查是否为首页
const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "";
const showHomeText = siteConfig.banner.homeText?.enable && isHomePage;
// 手机端非首页不显示banner的CSS类
const mobileNonHomeBannerClass = !isHomePage ? "mobile-hide-banner" : "";
```

### 修改后（Modified Code）

```javascript
// 1. 获取当前路径和基础路径
const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL; // 自动读取 Astro 配置的 base 路径

// 2. 标准化路径函数：移除末尾斜杠，确保 "/Mistn" 与 "/Mistn/" 视为同一路径
const normalizePath = (path: string) => path.replace(/\/$/, "") || "/";

// 3. 修正后的首页判断逻辑
const isHomePage = 
    normalizePath(currentPath) === normalizePath(base) || 
    currentPath === "/" || 
    currentPath === "";

const showHomeText = siteConfig.banner.homeText?.enable && isHomePage;
// 手机端 CSS 类逻辑保持不变，依赖正确的 isHomePage 状态
const mobileNonHomeBannerClass = !isHomePage ? "mobile-hide-banner" : "";
```

# 结果验证

应用上述修改并重新构建（Build）后：
1.  `isHomePage` 能够正确识别子路径首页（如 `/Mistn/`）。
2.  `showHomeText` 状态正确，打字机特效容器移除 `hidden` 类，首屏即显示。
3.  `mobileNonHomeBannerClass` 为空，移动端 Banner 正常展开。

该修复方案兼容根目录部署与子目录部署，具有更好的鲁棒性。
